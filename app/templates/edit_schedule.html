{% extends "base.html" %}

{% block title %}
    {% if schedule %}일정 정보 수정: {{ schedule.title }}{% else %}일정 찾을 수 없음{% endif %}
{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">
        {% if schedule %}일정 정보 수정: {{ schedule.title }}{% else %}일정을 찾을 수 없습니다.{% endif %}
    </h1>

    {% if not schedule %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">오류!</strong>
            <span class="block sm:inline">요청하신 일정을 찾을 수 없습니다.</span>
        </div>
        <div class="mt-6">
            <a href="{{ url_for('schedule.schedules_page') }}"
               class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">
                일정 목록으로 돌아가기
            </a>
        </div>
    {% else %}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                    {% for category, message in messages %}
                        <div class="p-3 rounded-md {% if category == 'success' %}bg-green-100 text-green-800{% elif category == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        {% if error %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">오류!</strong>
                <span class="block sm:inline">{{ error }}</span>
            </div>
        {% endif %}
        {% if message %}
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">성공!</strong>
                <span class="block sm:inline">{{ message }}</span>
            </div>
        {% endif %}

        <div class="bg-white shadow-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">일정 정보 수정</h2>
            <form action="{{ url_for('schedule.edit_schedule_page', schedule_id=schedule.id) }}" method="POST">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="mb-4">
                        <label for="title" class="block text-gray-700 text-sm font-bold mb-2">제목:</label>
                        <input type="text" name="title" id="title" value="{{ request.form.get('title', schedule.title) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        {% if errors and errors.title %}
                            <p class="text-red-500 text-xs italic">{{ errors.title }}</p>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="destination" class="block text-gray-700 text-sm font-bold mb-2">목적지:</label>
                        <input type="text" name="destination" id="destination" value="{{ request.form.get('destination', schedule.destination) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        {% if errors and errors.destination %}
                            <p class="text-red-500 text-xs italic">{{ errors.destination }}</p>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="start_date" class="block text-gray-700 text-sm font-bold mb-2">시작일:</label>
                        <input type="datetime-local" name="start_date" id="start_date" 
                               value="{{ request.form.get('start_date', schedule.start_date.replace('T', 'T') if schedule.start_date else '') }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        {% if errors and errors.start_date %}
                            <p class="text-red-500 text-xs italic">{{ errors.start_date }}</p>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="end_date" class="block text-gray-700 text-sm font-bold mb-2">종료일:</label>
                        <input type="datetime-local" name="end_date" id="end_date" 
                               value="{{ request.form.get('end_date', schedule.end_date.replace('T', 'T') if schedule.end_date else '') }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        {% if errors and errors.end_date %}
                            <p class="text-red-500 text-xs italic">{{ errors.end_date }}</p>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="price" class="block text-gray-700 text-sm font-bold mb-2">가격:</label>
                        <input type="number" name="price" id="price" step="0.01" value="{{ request.form.get('price', schedule.price) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        {% if errors and errors.price %}
                            <p class="text-red-500 text-xs italic">{{ errors.price }}</p>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="max_people" class="block text-gray-700 text-sm font-bold mb-2">최대 인원:</label>
                        <input type="number" name="max_people" id="max_people" value="{{ request.form.get('max_people', schedule.max_people) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        {% if errors and errors.max_people %}
                            <p class="text-red-500 text-xs italic">{{ errors.max_people }}</p>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label for="status" class="block text-gray-700 text-sm font-bold mb-2">상태:</label>
                        <select name="status" id="status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="Pending" {% if request.form.get('status', schedule.status) == 'Pending' %}selected{% endif %}>대기</option>
                            <option value="Confirmed" {% if request.form.get('status', schedule.status) == 'Confirmed' %}selected{% endif %}>확정</option>
                            <option value="Cancelled" {% if request.form.get('status', schedule.status) == 'Cancelled' %}selected{% endif %}>취소</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="duration" class="block text-gray-700 text-sm font-bold mb-2">기간:</label>
                        <input type="text" name="duration" id="duration" value="{{ request.form.get('duration', schedule.duration) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label for="region" class="block text-gray-700 text-sm font-bold mb-2">지역:</label>
                        <input type="text" name="region" id="region" value="{{ request.form.get('region', schedule.region) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label for="meeting_date" class="block text-gray-700 text-sm font-bold mb-2">모임 날짜:</label>
                        <input type="date" name="meeting_date" id="meeting_date" value="{{ request.form.get('meeting_date', schedule.meeting_date) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label for="meeting_time" class="block text-gray-700 text-sm font-bold mb-2">모임 시간:</label>
                        <input type="time" name="meeting_time" id="meeting_time" value="{{ request.form.get('meeting_time', schedule.meeting_time) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label for="meeting_place" class="block text-gray-700 text-sm font-bold mb-2">모임 장소:</label>
                        <input type="text" name="meeting_place" id="meeting_place" value="{{ request.form.get('meeting_place', schedule.meeting_place) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label for="manager" class="block text-gray-700 text-sm font-bold mb-2">담당자:</label>
                        <input type="text" name="manager" id="manager" value="{{ request.form.get('manager', schedule.manager) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label for="reservation_maker" class="block text-gray-700 text-sm font-bold mb-2">예약 담당자:</label>
                        <input type="text" name="reservation_maker" id="reservation_maker" value="{{ request.form.get('reservation_maker', schedule.reservation_maker) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="mb-4">
                        <label for="reservation_maker_contact" class="block text-gray-700 text-sm font-bold mb-2">예약 담당자 연락처:</label>
                        <input type="text" name="reservation_maker_contact" id="reservation_maker_contact" value="{{ request.form.get('reservation_maker_contact', schedule.reservation_maker_contact) }}"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>

                    <div class="md:col-span-2 mb-4">
                        <label for="description" class="block text-gray-700 text-sm font-bold mb-2">설명:</label>
                        <textarea name="description" id="description"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3">{{ request.form.get('description', schedule.description) }}</textarea>
                    </div>

                    <div class="md:col-span-2 mb-4">
                        <label for="important_docs" class="block text-gray-700 text-sm font-bold mb-2">중요 문서:</label>
                        <textarea name="important_docs" id="important_docs"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3">{{ request.form.get('important_docs', schedule.important_docs) }}</textarea>
                    </div>

                    <div class="md:col-span-2 mb-4">
                        <label for="currency_info" class="block text-gray-700 text-sm font-bold mb-2">통화 정보:</label>
                        <textarea name="currency_info" id="currency_info"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3">{{ request.form.get('currency_info', schedule.currency_info) }}</textarea>
                    </div>

                    <div class="md:col-span-2 mb-4">
                        <label for="other_items" class="block text-gray-700 text-sm font-bold mb-2">기타 항목:</label>
                        <textarea name="other_items" id="other_items"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3">{{ request.form.get('other_items', schedule.other_items) }}</textarea>
                    </div>

                    <div class="md:col-span-2 mb-4">
                        <label for="memo" class="block text-gray-700 text-sm font-bold mb-2">메모:</label>
                        <textarea name="memo" id="memo"
                                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="3">{{ request.form.get('memo', schedule.memo) }}</textarea>
                    </div>
                </div>

                <div class="flex items-center justify-between mt-6">
                    <button type="submit"
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        일정 정보 업데이트
                    </button>
                    <a href="{{ url_for('schedule.schedules_page') }}"
                       class="inline-block align-baseline font-bold text-sm text-blue-500 hover:text-blue-800">
                        일정 목록으로 돌아가기
                    </a>
                </div>
            </form>
        </div>

        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">관련 예약</h2>
            {% if schedule_reservations %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">고객명</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">예약 날짜</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">인원</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">총 가격</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">작업</span></th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        {% for reservation in schedule_reservations %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ reservation.id }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ reservation.customer_name }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ reservation.booking_date }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ reservation.number_of_people }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ "{:,.0f}".format(reservation.total_price) }}원</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ get_status_color(reservation.status) }}">
                                        {{ get_status_text(reservation.status) }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <a href="{{ url_for('reservation.edit_reservation_page', reservation_id=reservation.id) }}"
                                       class="text-indigo-600 hover:text-indigo-900 mr-4">수정</a>
                                    <form action="{{ url_for('reservation.delete_reservation_page', reservation_id=reservation.id) }}" method="POST"
                                          class="inline" onsubmit="return confirm('정말로 이 예약을 삭제하시겠습니까?');">
                                        <button type="submit" class="text-red-600 hover:text-red-900">삭제</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-gray-600">이 일정에 대한 예약이 없습니다.</p>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %} 