{% extends "public_base.html" %}
{% block content %}
<div class="bg-white p-8 rounded-lg shadow-xl max-w-4xl mx-auto my-8">
    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">나의 여행 정보</h2>

    <!-- 예약 정보 (수정 불가) -->
    <div class="mb-8">
        <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">예약 상세</h3>
        {% if reservation %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                <p class="text-sm text-gray-500 font-medium">예약자명</p>
                <p class="text-lg font-semibold text-gray-800">{{ reservation.customer_name }}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                <p class="text-sm text-gray-500 font-medium">예약코드</p>
                <p class="text-lg font-semibold text-gray-800">{{ reservation.reservation_code }}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-md shadow-sm col-span-1 md:col-span-2">
                <p class="text-sm text-gray-500 font-medium">일정</p>
                <p class="text-lg font-semibold text-gray-800">{{ reservation.schedule_title }} ({{ reservation.travel_start_date | format_date }} ~ {{ reservation.travel_end_date | format_date }})</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 정보 수정 폼 -->
    <form id="update-info-form" method="POST" enctype="multipart/form-data" action="{{ url_for('public.update_my_info', reservation_code=reservation.reservation_code) }}">
        <!-- 인증 코드 입력 -->
        <div class="mb-6">
            <label for="email_dispatch_code" class="block text-sm font-medium text-gray-700">이메일 인증 코드</label>
            <input type="text" id="email_dispatch_code" name="email_dispatch_code" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="이메일로 받은 6자리 코드를 입력하세요">
        </div>

        <!-- 여행자 정보 수정 -->
        <div class="mb-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">여행자 정보 수정</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">이름</p>
                    <input type="text" id="name" name="name" value="{{ customer.name or '' }}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">연락처</p>
                    <input type="text" id="phone" name="phone" value="{{ customer.phone or '' }}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="email" class="block text-sm font-medium text-gray-700">이메일</p>
                    <input type="email" id="email" name="email" value="{{ customer.email or '' }}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
        </div>

        <!-- 여권 정보 수정 -->
        <div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">여권 정보 수정</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="passport_number" class="block text-sm font-medium text-gray-700">여권 번호</p>
                    <input type="text" id="passport_number" name="passport_number" value="{{ passport_info.passport_number or '' }}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="expiry_date" class="block text-sm font-medium text-gray-700">만료일</p>
                    <input type="date" id="expiry_date" name="expiry_date" value="{{ passport_info.expiry_date or '' }}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="last_name_eng" class="block text-sm font-medium text-gray-700">영문 성</p>
                    <input type="text" id="last_name_eng" name="last_name_eng" value="{{ passport_info.last_name_eng or '' }}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="first_name_eng" class="block text-sm font-medium text-gray-700">영문 이름</p>
                    <input type="text" id="first_name_eng" name="first_name_eng" value="{{ passport_info.first_name_eng or '' }}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="passport_photo" class="block text-sm font-medium text-gray-700">여권 사본 업로드</p>
                    <input type="file" id="passport_photo" name="passport_photo" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                    {% if passport_info and passport_info.passport_photo_path %}
                    <div class="mt-4 flex items-center">
                        <img id="passport-preview" src="{{ url_for('static', filename='uploads/' + passport_info.passport_photo_path) }}" alt="Passport Photo" class="h-20 w-auto rounded-md shadow-sm">
                        <label for="delete_passport_photo" class="ml-4 flex items-center text-sm text-gray-600">
                            <input type="checkbox" id="delete_passport_photo" name="delete_passport_photo" value="true" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="ml-2">기존 사진 삭제</span>
                        </label>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="mt-8 text-center">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                정보 저장하기
            </button>
        </div>
    </form>
    <div id="form-message" class="mt-4 text-center"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('update-info-form').addEventListener('submit', function(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const messageDiv = document.getElementById('form-message');

    fetch(form.action, {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageDiv.innerHTML = `<p class="text-green-600">${data.message}</p>`;
            // Optionally, update fields or image preview if changed
            if (data.new_photo_path) {
                const preview = document.getElementById('passport-preview');
                if (preview) {
                    preview.src = '/static/uploads/' + data.new_photo_path;
                    document.getElementById('delete_passport_photo').checked = false;
                } else {
                    // If no preview existed, might need to reload or dynamically add it
                    window.location.reload();
                }
            } else if (formData.get('delete_passport_photo')) {
                const preview = document.getElementById('passport-preview');
                if (preview) {
                    preview.parentElement.remove();
                }
            }
        } else {
            messageDiv.innerHTML = `<p class="text-red-600">오류: ${data.error}</p>`;
        }
    })
    .catch(error => {
        messageDiv.innerHTML = `<p class="text-red-600">요청 중 오류가 발생했습니다: ${error}</p>`;
    });
});
</script>
{% endblock %}
